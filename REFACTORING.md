# ä»£ç é‡æ„è¯´æ˜

## ğŸ“‹ é‡æ„æ¦‚è§ˆ

æœ¬æ¬¡é‡æ„å¯¹æ•´ä¸ªé¡¹ç›®è¿›è¡Œäº†å…¨é¢çš„ä»£ç ç»„ç»‡ä¼˜åŒ–ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œå¯æ‰©å±•æ€§ã€‚

## ğŸ¯ é‡æ„ç›®æ ‡

1. **æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†**ï¼šæŒ‰ç…§èŒè´£å°†ä»£ç åˆ†å±‚ç»„ç»‡
2. **æ¶ˆé™¤é‡å¤ä»£ç **ï¼šæå–å…¬å…±é€»è¾‘åˆ°ä¸“é—¨çš„æ¨¡å—
3. **æé«˜å¯æµ‹è¯•æ€§**ï¼šåˆ›å»º lib.rs å’Œç‹¬ç«‹çš„æµ‹è¯•ç›®å½•
4. **æ”¹å–„å‘½åè§„èŒƒ**ï¼šè§£å†³å‘½åå†²çªå’Œä¸è§„èŒƒçš„é—®é¢˜
5. **ç»Ÿä¸€æŠ½è±¡å±‚**ï¼šä¸º API è°ƒç”¨æä¾›ç»Ÿä¸€çš„å®¢æˆ·ç«¯æ¥å£

## ğŸ“ æ–°çš„ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ main.rs                          # ç®€æ´çš„ç¨‹åºå…¥å£
â”œâ”€â”€ lib.rs                           # åº“å…¥å£ï¼Œå¯¼å‡ºå…¬å…±æ¥å£
â”œâ”€â”€ app.rs                           # åº”ç”¨ä¸»é€»è¾‘ï¼ˆä¼˜åŒ–åï¼‰
â”œâ”€â”€ config.rs                        # é…ç½®ç®¡ç†
â”œâ”€â”€ error.rs                         # é”™è¯¯ç±»å‹å®šä¹‰
â”œâ”€â”€ logger.rs                        # æ—¥å¿—åˆå§‹åŒ–
â”‚
â”œâ”€â”€ browser/                         # æµè§ˆå™¨æ“ä½œ
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ connection.rs
â”‚   â””â”€â”€ headless.rs
â”‚
â”œâ”€â”€ clients/                         # âœ¨ æ–°å¢ï¼šAPI å®¢æˆ·ç«¯å±‚
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ tiku_client.rs              # é¢˜åº“ API å®¢æˆ·ç«¯
â”‚   â””â”€â”€ llm_client.rs               # LLM API å®¢æˆ·ç«¯
â”‚
â”œâ”€â”€ models/                          # é‡å‘½åï¼šmodel â†’ models
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ question.rs                 # é‡å‘½åï¼šmodel.rs â†’ question.rs
â”‚   â”œâ”€â”€ grade.rs
â”‚   â”œâ”€â”€ subject.rs
â”‚   â””â”€â”€ loaders/                    # âœ¨ æ–°å¢ï¼šæ•°æ®åŠ è½½å™¨å­æ¨¡å—
â”‚       â”œâ”€â”€ mod.rs
â”‚       â””â”€â”€ toml_loader.rs
â”‚
â”œâ”€â”€ services/                        # âœ¨ æ–°å¢ï¼šä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ paper_service.rs            # è¯•å·å¤„ç†æœåŠ¡
â”‚   â”œâ”€â”€ question_service.rs         # é¢˜ç›®å¤„ç†æœåŠ¡
â”‚   â”œâ”€â”€ search_service.rs           # æœç´¢æœåŠ¡
â”‚   â””â”€â”€ matching_service.rs         # é¢˜ç›®åŒ¹é…æœåŠ¡
â”‚
â””â”€â”€ utils/                           # âœ¨ æ–°å¢ï¼šå·¥å…·å‡½æ•°
    â”œâ”€â”€ mod.rs
    â””â”€â”€ logging.rs                  # æ—¥å¿—è¾…åŠ©å‡½æ•°

tests/                               # âœ¨ æ–°å¢ï¼šé›†æˆæµ‹è¯•ç›®å½•
â””â”€â”€ integration_test.rs
```

## ğŸ”„ ä¸»è¦å˜æ›´

### 1. åˆ›å»ºå®¢æˆ·ç«¯å±‚ï¼ˆclients/ï¼‰

**ä¹‹å‰çš„é—®é¢˜ï¼š**
- API è°ƒç”¨é€»è¾‘åˆ†æ•£åœ¨ `search_bank.rs` å’Œ `paper_processor.rs` ä¸­
- é‡å¤çš„ HTTP è¯·æ±‚ä»£ç 
- ç¼ºå°‘ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

**é‡æ„åï¼š**
- `clients/tiku_client.rs`ï¼šå°è£…æ‰€æœ‰é¢˜åº“ API è°ƒç”¨
  - `search_question()` - æœç´¢é¢˜ç›®
  - `save_question()` - ä¿å­˜é¢˜ç›®
  - `save_title()` - ä¿å­˜æ ‡é¢˜
  - `submit_paper()` - æäº¤è¯•å·
  
- `clients/llm_client.rs`ï¼šå°è£…æ‰€æœ‰ LLM API è°ƒç”¨
  - `chat()` - å‘é€èŠå¤©è¯·æ±‚
  - `simple_chat()` - ç®€å•èŠå¤©ï¼ˆä¸å¸¦ç³»ç»Ÿæ¶ˆæ¯ï¼‰

**ä¼˜åŠ¿ï¼š**
- ç»Ÿä¸€çš„ API è°ƒç”¨æ¥å£
- é›†ä¸­çš„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
- ä¾¿äº Mock å’Œå•å…ƒæµ‹è¯•
- é…ç½®é›†ä¸­ç®¡ç†

### 2. åˆ›å»ºæœåŠ¡å±‚ï¼ˆservices/ï¼‰

**ä¹‹å‰çš„é—®é¢˜ï¼š**
- `paper_processor.rs` æ–‡ä»¶è¿‡å¤§ï¼ˆ560+ è¡Œï¼‰
- æ··åˆäº†å¤šç§èŒè´£ï¼šä¸šåŠ¡é€»è¾‘ã€API è°ƒç”¨ã€æ—¥å¿—ã€æ–‡ä»¶æ“ä½œ
- `ask_llm.rs` åŒæ—¶åŒ…å«é€šç”¨å’Œç‰¹å®šé€»è¾‘

**é‡æ„åï¼š**
- `services/paper_service.rs`ï¼šè¯•å·çº§åˆ«çš„å¤„ç†é€»è¾‘
  - éå†é¢˜ç›®
  - æäº¤è¯•å·
  - æ–‡ä»¶æ¸…ç†
  
- `services/question_service.rs`ï¼šé¢˜ç›®çº§åˆ«çš„å¤„ç†é€»è¾‘
  - æœç´¢é¢˜ç›®
  - åŒ¹é…é¢˜ç›®
  - æäº¤é¢˜ç›®
  
- `services/search_service.rs`ï¼šæœç´¢æœåŠ¡
  - ç»Ÿä¸€çš„æœç´¢é€»è¾‘
  - é‡è¯•æœºåˆ¶
  - ç»“æœè§£æ
  
- `services/matching_service.rs`ï¼šé¢˜ç›®åŒ¹é…æœåŠ¡
  - å¿«é€ŸåŒ¹é…ç®—æ³•
  - LLM åˆ¤æ–­é€»è¾‘
  - æç¤ºè¯æ„å»º

**ä¼˜åŠ¿ï¼š**
- å•ä¸€èŒè´£åŸåˆ™
- æ›´å°çš„å‡½æ•°å’Œæ¨¡å—
- æ˜“äºç†è§£å’Œç»´æŠ¤
- å¯ç‹¬ç«‹æµ‹è¯•æ¯ä¸ªæœåŠ¡

### 3. é‡ç»„æ¨¡å‹å±‚ï¼ˆmodels/ï¼‰

**ä¹‹å‰çš„é—®é¢˜ï¼š**
- `model/model.rs` å‘½åé‡å¤
- ç¼ºå°‘å­æ¨¡å—ç»„ç»‡

**é‡æ„åï¼š**
- `models/question.rs`ï¼ˆä» `model.rs` é‡å‘½åï¼‰
- `models/loaders/toml_loader.rs`ï¼ˆæå–åˆ°å­æ¨¡å—ï¼‰
- æ¸…æ™°çš„æ¨¡å—å±‚æ¬¡ç»“æ„

**ä¼˜åŠ¿ï¼š**
- æ¶ˆé™¤å‘½åæ­§ä¹‰
- æ›´å¥½çš„ä»£ç ç»„ç»‡
- ä¾¿äºæ·»åŠ æ–°çš„åŠ è½½å™¨

### 4. åˆ›å»ºå·¥å…·å±‚ï¼ˆutils/ï¼‰

**ä¹‹å‰çš„é—®é¢˜ï¼š**
- æ—¥å¿—æ ¼å¼åŒ–å‡½æ•°åˆ†æ•£åœ¨ `app.rs` å’Œ `paper_processor.rs` ä¸­
- é‡å¤çš„æ—¥å¿—ä»£ç 

**é‡æ„åï¼š**
- `utils/logging.rs`ï¼šç»Ÿä¸€çš„æ—¥å¿—è¾…åŠ©å‡½æ•°
  - `init_log_file()` - åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶
  - `log_startup()` - è®°å½•å¯åŠ¨ä¿¡æ¯
  - `log_papers_loaded()` - è®°å½•åŠ è½½ä¿¡æ¯
  - `log_batch_start()` - è®°å½•æ‰¹æ¬¡å¼€å§‹
  - `log_batch_complete()` - è®°å½•æ‰¹æ¬¡å®Œæˆ
  - `print_final_stats()` - æ‰“å°æœ€ç»ˆç»Ÿè®¡

**ä¼˜åŠ¿ï¼š**
- æ¶ˆé™¤é‡å¤ä»£ç 
- ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼
- æ˜“äºæ‰©å±•

### 5. åˆ›å»ºåº“å…¥å£ï¼ˆlib.rsï¼‰

**ä¹‹å‰çš„é—®é¢˜ï¼š**
- æ‰€æœ‰ä»£ç åªèƒ½ä½œä¸ºäºŒè¿›åˆ¶ä½¿ç”¨
- æµ‹è¯•åªèƒ½æ”¾åœ¨ `main.rs` ä¸­
- æ— æ³•è¢«å…¶ä»–é¡¹ç›®å¼•ç”¨

**é‡æ„åï¼š**
- åˆ›å»º `src/lib.rs`
- å¯¼å‡ºå…¬å…±æ¥å£
- æ”¯æŒä½œä¸ºåº“ä½¿ç”¨

**ä¼˜åŠ¿ï¼š**
- æ”¯æŒé›†æˆæµ‹è¯•
- å¯ä»¥è¢«å…¶ä»–é¡¹ç›®å¼•ç”¨
- æ›´å¥½çš„ä»£ç ç»„ç»‡

### 6. ç‹¬ç«‹æµ‹è¯•ç›®å½•ï¼ˆtests/ï¼‰

**ä¹‹å‰çš„é—®é¢˜ï¼š**
- æµ‹è¯•ä»£ç æ”¾åœ¨ `main.rs` ä¸­
- éš¾ä»¥ç®¡ç†å’Œæ‰©å±•

**é‡æ„åï¼š**
- åˆ›å»º `tests/integration_test.rs`
- æµ‹è¯•ä¸ä¸»ä»£ç åˆ†ç¦»
- æ·»åŠ å¤šä¸ªæµ‹è¯•ç”¨ä¾‹

**ä¼˜åŠ¿ï¼š**
- æ¸…æ™°çš„æµ‹è¯•ç»„ç»‡
- æ˜“äºæ·»åŠ æ–°æµ‹è¯•
- æ›´å¥½çš„æµ‹è¯•éš”ç¦»

## ğŸ“Š ä»£ç ç»Ÿè®¡å¯¹æ¯”

### é‡æ„å‰
- `paper_processor.rs`: 560+ è¡Œï¼ˆæ··åˆèŒè´£ï¼‰
- `ask_llm.rs`: 200+ è¡Œï¼ˆæ··åˆé€šç”¨å’Œç‰¹å®šé€»è¾‘ï¼‰
- `search_bank.rs`: 150+ è¡Œï¼ˆæœç´¢é€»è¾‘ï¼‰
- `app.rs`: 250+ è¡Œï¼ˆåŒ…å«æ—¥å¿—å‡½æ•°ï¼‰

### é‡æ„å
- `services/paper_service.rs`: 183 è¡Œï¼ˆä¸“æ³¨è¯•å·å¤„ç†ï¼‰
- `services/question_service.rs`: 205 è¡Œï¼ˆä¸“æ³¨é¢˜ç›®å¤„ç†ï¼‰
- `services/matching_service.rs`: 238 è¡Œï¼ˆä¸“æ³¨åŒ¹é…é€»è¾‘ï¼‰
- `services/search_service.rs`: 146 è¡Œï¼ˆä¸“æ³¨æœç´¢é€»è¾‘ï¼‰
- `clients/tiku_client.rs`: 217 è¡Œï¼ˆé¢˜åº“ APIï¼‰
- `clients/llm_client.rs`: 103 è¡Œï¼ˆLLM APIï¼‰
- `utils/logging.rs`: 116 è¡Œï¼ˆæ—¥å¿—å·¥å…·ï¼‰
- `app.rs`: 190 è¡Œï¼ˆç²¾ç®€åçš„ä¸»é€»è¾‘ï¼‰

**æ”¹è¿›ï¼š**
- å¹³å‡æ¯ä¸ªæ–‡ä»¶å‡å°‘åˆ° 150-240 è¡Œ
- èŒè´£æ›´åŠ æ˜ç¡®
- æ¨¡å—åŒ–ç¨‹åº¦æ›´é«˜

## ğŸ¨ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. åˆ†å±‚æ¶æ„ï¼ˆLayered Architectureï¼‰
```
Presentation Layer  â†’ app.rs (åº”ç”¨å…¥å£)
    â†“
Service Layer       â†’ services/ (ä¸šåŠ¡é€»è¾‘)
    â†“
Client Layer        â†’ clients/ (API å®¢æˆ·ç«¯)
    â†“
Model Layer         â†’ models/ (æ•°æ®æ¨¡å‹)
```

### 2. ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰
æœåŠ¡å±‚é€šè¿‡æ„é€ å‡½æ•°æ¥æ”¶ Configï¼Œé¿å…ç¡¬ç¼–ç ï¼š
```rust
impl PaperService {
    pub fn new(config: &Config) -> Self {
        Self {
            question_service: QuestionService::new(config),
            tiku_client: TikuClient::new(config),
        }
    }
}
```

### 3. å•ä¸€èŒè´£åŸåˆ™ï¼ˆSingle Responsibility Principleï¼‰
æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„åŠŸèƒ½é¢†åŸŸï¼š
- `TikuClient`ï¼šåªè´Ÿè´£é¢˜åº“ API è°ƒç”¨
- `SearchService`ï¼šåªè´Ÿè´£æœç´¢é€»è¾‘
- `MatchingService`ï¼šåªè´Ÿè´£åŒ¹é…é€»è¾‘

### 4. é—¨é¢æ¨¡å¼ï¼ˆFacade Patternï¼‰
`PaperService` ä½œä¸ºé—¨é¢ï¼Œåè°ƒå¤šä¸ªå­æœåŠ¡ï¼š
```rust
pub async fn process_paper(&self, ...) -> Result<bool> {
    // åè°ƒ QuestionService å’Œ TikuClient
}
```

## ğŸš€ ä½¿ç”¨æŒ‡å—

### è¿è¡Œç¨‹åº
```bash
cargo run
```

### è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…æ‹¬è¢«å¿½ç•¥çš„ï¼‰
cargo test -- --ignored

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test test_add_single_paper -- --ignored
```

### ä½œä¸ºåº“ä½¿ç”¨
```rust
use add_question_submit::{Config, PaperService};

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    let config = Config::from_env();
    let paper_service = PaperService::new(&config);
    // ... ä½¿ç”¨æœåŠ¡
    Ok(())
}
```

## ğŸ”§ è¿ç§»æŒ‡å—

å¦‚æœä½ æœ‰åŸºäºæ—§ä»£ç çš„ä»£ç ï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

### 1. å¯¼å…¥è·¯å¾„å˜æ›´
```rust
// æ—§
use crate::model::model::QuestionPage;
use crate::paper_processor::process_single_paper;
use crate::ask_llm::ask_llm_for_which_index;

// æ–°
use crate::models::QuestionPage;
use crate::services::PaperService;
use crate::services::MatchingService;
```

### 2. å‡½æ•°è°ƒç”¨å˜æ›´
```rust
// æ—§
process_single_paper(&page, paper_data, index, &config).await?;

// æ–°
let paper_service = PaperService::new(&config);
paper_service.process_paper(&page, paper_data, index).await?;
```

### 3. API è°ƒç”¨å˜æ›´
```rust
// æ—§ï¼šç›´æ¥æ„å»º fetch è„šæœ¬
let script = format!("fetch(...)");

// æ–°ï¼šä½¿ç”¨å®¢æˆ·ç«¯
let tiku_client = TikuClient::new(&config);
let result = tiku_client.search_question(&page, stem, subject_code).await?;
```

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **é”™è¯¯å¤„ç†æ”¹è¿›**
   - å½“å‰è¿˜åœ¨ä½¿ç”¨ `anyhow::Result`
   - å»ºè®®é€æ­¥è¿ç§»åˆ°è‡ªå®šä¹‰çš„ `AppError`

2. **é…ç½®ç®¡ç†å¢å¼º**
   - è€ƒè™‘æ·»åŠ  `.env` æ–‡ä»¶æ”¯æŒï¼ˆä½¿ç”¨ `dotenv` crateï¼‰
   - æ·»åŠ é…ç½®éªŒè¯é€»è¾‘

3. **æ—¥å¿—ä¼˜åŒ–**
   - è€ƒè™‘ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
   - æ·»åŠ æ—¥å¿—çº§åˆ«æ§åˆ¶

4. **æµ‹è¯•è¦†ç›–**
   - ä¸ºæ¯ä¸ªæœåŠ¡æ·»åŠ å•å…ƒæµ‹è¯•
   - å¢åŠ  Mock æµ‹è¯•

5. **æ–‡æ¡£å®Œå–„**
   - ä¸ºå…¬å…± API æ·»åŠ æ›´å¤šç¤ºä¾‹
   - åˆ›å»ºæ¶æ„å†³ç­–è®°å½•ï¼ˆADRï¼‰

## ğŸ“ æ€»ç»“

æœ¬æ¬¡é‡æ„éµå¾ªäº†è½¯ä»¶å·¥ç¨‹çš„æœ€ä½³å®è·µï¼š

âœ… **å•ä¸€èŒè´£åŸåˆ™**ï¼šæ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä»¶äº‹  
âœ… **å¼€é—­åŸåˆ™**ï¼šæ˜“äºæ‰©å±•ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç   
âœ… **ä¾èµ–å€’ç½®åŸåˆ™**ï¼šé«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—  
âœ… **æ¥å£éš”ç¦»åŸåˆ™**ï¼šå®¢æˆ·ç«¯ä¸åº”è¯¥ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£  
âœ… **DRY åŸåˆ™**ï¼šæ¶ˆé™¤é‡å¤ä»£ç   

é‡æ„åçš„ä»£ç æ›´åŠ æ¸…æ™°ã€å¯ç»´æŠ¤ã€å¯æµ‹è¯•ï¼Œä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•æ‰“ä¸‹äº†è‰¯å¥½çš„åŸºç¡€ã€‚

---

**é‡æ„æ—¥æœŸ**ï¼š2024å¹´  
**é‡æ„äººå‘˜**ï¼šAI Assistant  
**ä»£ç å®¡æŸ¥**ï¼šå¾…è¿›è¡Œ