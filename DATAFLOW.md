# æ•°æ®æµå‘å›¾

## ä¸€ã€å®Œæ•´æ•°æ®æµï¼ˆä»å¯åŠ¨åˆ°ç»“æŸï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          main.rs                                 â”‚
â”‚                        ç¨‹åºå…¥å£                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         App::initialize()                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. åŠ è½½é…ç½® (Config)                                      â”‚   â”‚
â”‚  â”‚ 2. è¿æ¥æµè§ˆå™¨ â†’ è·å–å”¯ä¸€çš„ Pageï¼ˆç¨€ç¼ºèµ„æºï¼‰                â”‚   â”‚
â”‚  â”‚ 3. åˆå§‹åŒ–æ—¥å¿—                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         App::run()                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. åŠ è½½æ‰€æœ‰ TOML æ–‡ä»¶ â†’ Vec<QuestionPage>                â”‚   â”‚
â”‚  â”‚ 2. åˆ†æ‰¹å¤„ç†ï¼ˆæ¯æ‰¹ N ä¸ªï¼‰                                  â”‚   â”‚
â”‚  â”‚ 3. ç»Ÿè®¡ç»“æœ                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ for each batch
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    App::process_batch()                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å¹¶å‘æ‰§è¡Œå¤šä¸ª process_paper()                              â”‚   â”‚
â”‚  â”‚ ä½¿ç”¨ tokio::spawn + Semaphore æ§åˆ¶å¹¶å‘                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ for each paper in batch
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               processing::process_paper()                        â”‚
â”‚                     ã€â‘£ ç¼–æ’å±‚ã€‘                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Input:  Page, QuestionPage, Config                       â”‚   â”‚
â”‚  â”‚ Output: Result<bool>                                     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ èŒè´£ï¼š                                                    â”‚   â”‚
â”‚  â”‚ - éå† paper.stemlist (Vec<Question>)                   â”‚   â”‚
â”‚  â”‚ - ä¸ºæ¯é“é¢˜åˆ›å»º QuestionCtx                               â”‚   â”‚
â”‚  â”‚ - è°ƒç”¨ QuestionFlow.run()                                â”‚   â”‚
â”‚  â”‚ - ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡                                       â”‚   â”‚
â”‚  â”‚ - æäº¤è¯•å·                                                â”‚   â”‚
â”‚  â”‚ - æ¸…ç†æ–‡ä»¶                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ for each question
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QuestionFlow::run()                           â”‚
â”‚                      ã€â‘¢ æµç¨‹å±‚ã€‘                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Input:  &Page, &Question, &QuestionCtx                   â”‚   â”‚
â”‚  â”‚ Output: Result<ProcessResult>                            â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ æµç¨‹ï¼š                                                    â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 1. æ˜¾ç¤ºé¢˜å¹²é¢„è§ˆ                                          â”‚   â”‚
â”‚  â”‚    â”‚                                                     â”‚   â”‚
â”‚  â”‚    â–¼                                                     â”‚   â”‚
â”‚  â”‚ 2. è°ƒç”¨ SearchService.search()  â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚  â”‚    â”‚                                 â”‚                   â”‚   â”‚
â”‚  â”‚    â–¼                                 â”‚                   â”‚   â”‚
â”‚  â”‚ 3. if results.is_empty()             â”‚                   â”‚   â”‚
â”‚  â”‚    â”‚                                 â”‚                   â”‚   â”‚
â”‚  â”‚    â”œâ”€ æ˜¯ â†’ write_warn() â†’ Skipped   â”‚                   â”‚   â”‚
â”‚  â”‚    â”‚                                 â”‚                   â”‚   â”‚
â”‚  â”‚    â””â”€ å¦ â”€â”                          â”‚                   â”‚   â”‚
â”‚  â”‚           â–¼                          â”‚                   â”‚   â”‚
â”‚  â”‚ 4. è°ƒç”¨ MatchingService.find_best() â”€â”¤                   â”‚   â”‚
â”‚  â”‚    â”‚                                 â”‚                   â”‚   â”‚
â”‚  â”‚    â–¼                                 â”‚                   â”‚   â”‚
â”‚  â”‚ 5. submit_question()                 â”‚                   â”‚   â”‚
â”‚  â”‚    â”‚                                 â”‚                   â”‚   â”‚
â”‚  â”‚    â–¼                                 â”‚                   â”‚   â”‚
â”‚  â”‚ 6. Success                           â”‚                   â”‚   â”‚
â”‚  â”‚                                      â”‚                   â”‚   â”‚
â”‚  â”‚         ä½¿ç”¨ â‘¡ ä¸šåŠ¡èƒ½åŠ›å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SearchServiceâ”‚  â”‚MatchingServiceâ”‚ â”‚ WarnWriter   â”‚
â”‚  ã€â‘¡ èƒ½åŠ›å±‚ã€‘â”‚  â”‚  ã€â‘¡ èƒ½åŠ›å±‚ã€‘ â”‚ â”‚ã€â‘¡ èƒ½åŠ›å±‚ã€‘  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ search()     â”‚  â”‚ find_best()  â”‚  â”‚ write()      â”‚
â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
â”‚ è¾“å…¥: stem   â”‚  â”‚ è¾“å…¥: resultsâ”‚  â”‚ è¾“å…¥: ctx    â”‚
â”‚       code   â”‚  â”‚       stem   â”‚  â”‚       questionâ”‚
â”‚              â”‚  â”‚       imgs   â”‚  â”‚              â”‚
â”‚ è¾“å‡º: Vec    â”‚  â”‚ è¾“å‡º: index  â”‚  â”‚ è¾“å‡º: ()     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â”‚                 â”‚
       â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TikuClient   â”‚  â”‚ LlmClient    â”‚
â”‚ã€HTTPå®¢æˆ·ç«¯ã€‘â”‚  â”‚ã€HTTPå®¢æˆ·ç«¯ã€‘â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     Page     â”‚
        â”‚ã€â‘  åŸºç¡€è®¾æ–½ã€‘â”‚
        â”‚              â”‚
        â”‚ eval(js)     â”‚
        â”‚ å”¯ä¸€èµ„æº     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å•ä¸ªé¢˜ç›®çš„è¯¦ç»†æµç¨‹

```
é¢˜ç›®æ•°æ® (Question)
    â”‚
    â”‚ stem: "1+1=?"
    â”‚ imgs: Some([...])
    â”‚ is_title: false
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        QuestionCtx (ä¸Šä¸‹æ–‡å°è£…)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ paper_id: "12345"                           â”‚
â”‚ paper_index: 1                              â”‚
â”‚ question_index: 5                           â”‚
â”‚ subject_code: "1"                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     QuestionFlow::run(&page, &q, &ctx)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€ 1. log_stem() â†’ æ˜¾ç¤ºé¢˜å¹²é¢„è§ˆ
                  â”‚
                  â”œâ”€ 2. self.search_service.search(page, stem, code)
                  â”‚    â”‚
                  â”‚    â”œâ”€ TikuClient.search_question(page, stem, code)
                  â”‚    â”‚    â”‚
                  â”‚    â”‚    â””â”€ page.evaluate(js_code)  â”€â”€â”
                  â”‚    â”‚                                 â”‚
                  â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚    â”‚    â–¼
                  â”‚    â”‚    è¿”å›: JSON { data: [...] }
                  â”‚    â”‚
                  â”‚    â””â”€ è§£æ: Vec<SearchResult>
                  â”‚         [{
                  â”‚           question_content: "...",
                  â”‚           similarity: 0.95,
                  â”‚           img_urls: [...]
                  â”‚         }, ...]
                  â”‚
                  â”œâ”€ 3. if results.is_empty()
                  â”‚    â”‚
                  â”‚    â”œâ”€ æ˜¯ â”€â”€> write_warn(ctx, question)
                  â”‚    â”‚          â”‚
                  â”‚    â”‚          â””â”€ å†™å…¥ warn.txt:
                  â”‚    â”‚             "è¯•å· 12345 | é¢˜ç›® 5 | ..."
                  â”‚    â”‚          
                  â”‚    â”‚          return Ok(ProcessResult::Skipped)
                  â”‚    â”‚
                  â”‚    â””â”€ å¦ â”€â”€> ç»§ç»­
                  â”‚
                  â”œâ”€ 4. self.matching_service.find_best(results, stem, imgs)
                  â”‚    â”‚
                  â”‚    â”œâ”€ LlmClient.call_llm(prompt)
                  â”‚    â”‚    â”‚
                  â”‚    â”‚    â”œâ”€ æ„å»º prompt:
                  â”‚    â”‚    â”‚   "é¢˜ç›®: 1+1=?
                  â”‚    â”‚    â”‚    å€™é€‰1: ...
                  â”‚    â”‚    â”‚    å€™é€‰2: ...
                  â”‚    â”‚    â”‚    è¯·é€‰æ‹©æœ€åŒ¹é…çš„..."
                  â”‚    â”‚    â”‚
                  â”‚    â”‚    â””â”€ HTTP POST â†’ LLM API
                  â”‚    â”‚         â””â”€ è¿”å›: "1"
                  â”‚    â”‚
                  â”‚    â””â”€ è§£æ: selected_index = 0
                  â”‚
                  â”œâ”€ 5. build_question_data(result[0], paper_id, index)
                  â”‚    â”‚
                  â”‚    â””â”€ è¿”å›: {
                  â”‚         "addFlag": 1,
                  â”‚         "paperId": "12345",
                  â”‚         "questionIndex": 5,
                  â”‚         "sysCode": 1,
                  â”‚         ...åŸå§‹æ•°æ®...
                  â”‚       }
                  â”‚
                  â”œâ”€ 6. submit_question(page, question_data, paper_index)
                  â”‚    â”‚
                  â”‚    â”œâ”€ page.evaluate(
                  â”‚    â”‚    fetch('/tiku/api/paper/saveQuestion', {
                  â”‚    â”‚      method: 'POST',
                  â”‚    â”‚      body: JSON.stringify(question_data)
                  â”‚    â”‚    })
                  â”‚    â”‚  )
                  â”‚    â”‚
                  â”‚    â”œâ”€ è¿”å›: { code: 200, msg: "success" }
                  â”‚    â”‚
                  â”‚    â””â”€ if code == 200
                  â”‚         â””â”€ return Ok(ProcessResult::Success)
                  â”‚
                  â””â”€ 7. return Ok(ProcessResult::Success)
```

---

## ä¸‰ã€æ•°æ®ç±»å‹æµè½¬

```
TOML æ–‡ä»¶
   â”‚
   â”‚ parse
   â–¼
QuestionPage {
  page_id: "12345",
  name: "æ•°å­¦è¯•å·",
  subject: "æ•°å­¦",
  stemlist: Vec<Question>,
  file_path: "/path/to/file.toml"
}
   â”‚
   â”‚ for each question
   â–¼
Question {
  stem: "1+1=?",
  imgs: Some(["url1", "url2"]),
  is_title: false
}
   â”‚
   â”‚ + context
   â–¼
QuestionCtx {
  paper_id: "12345",
  paper_index: 1,
  question_index: 5,
  subject_code: "1"
}
   â”‚
   â”‚ search
   â–¼
Vec<SearchResult> {
  [
    SearchResult {
      question_content: "...",
      xkw_question_similarity: Some(0.95),
      img_urls: Some([...])
    },
    ...
  ]
}
   â”‚
   â”‚ matching
   â–¼
selected_index: usize = 0
   â”‚
   â”‚ build
   â–¼
question_data: serde_json::Value {
  "addFlag": 1,
  "paperId": "12345",
  "questionIndex": 5,
  ...
}
   â”‚
   â”‚ submit
   â–¼
ProcessResult::Success
```

---

## å››ã€èµ„æºæŒæœ‰å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              App (owner)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ browser: Browser                       â”‚
â”‚ page: Page  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ config: Config                 â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚               â”‚
                 â”‚ owns          â”‚ borrows (&Page)
                 â”‚               â”‚
                 â–¼               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
       â”‚ process_paper()  â”‚     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                â”‚               â”‚
                â”‚ borrows       â”‚
                â”‚               â”‚
                â–¼               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
       â”‚ QuestionFlow     â”‚     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                â”‚               â”‚
                â”‚ borrows       â”‚
                â”‚               â”‚
                â–¼               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
       â”‚ SearchService    â”‚â—„â”€â”€â”€â”€â”˜
       â”‚ MatchingService  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰€æœ‰äººéƒ½"å€Ÿç”¨" Pageï¼Œåªæœ‰ App "æŒæœ‰"å®ƒã€‚
```

---

## äº”ã€é”™è¯¯å¤„ç†æµ

```
QuestionFlow::run()
   â”‚
   â”œâ”€ SearchService::search()
   â”‚    â”‚
   â”‚    â”œâ”€ TikuClient::search_question()
   â”‚    â”‚    â”‚
   â”‚    â”‚    â”œâ”€ page.evaluate() 
   â”‚    â”‚    â”‚    â””â”€ Err(JsError) â†’ å‘ä¸Šä¼ æ’­
   â”‚    â”‚    â”‚
   â”‚    â”‚    â””â”€ é€Ÿç‡é™åˆ¶ â†’ é‡è¯• (æœ€å¤š 50 æ¬¡)
   â”‚    â”‚         â””â”€ ä»å¤±è´¥ â†’ return Ok(Vec::new())
   â”‚    â”‚
   â”‚    â””â”€ return Ok((Vec::new(), Vec::new()))
   â”‚
   â”œâ”€ if results.is_empty()
   â”‚    â””â”€ write_warn() â†’ return Ok(ProcessResult::Skipped)
   â”‚
   â”œâ”€ MatchingService::find_best()
   â”‚    â”‚
   â”‚    â””â”€ LlmClient::call_llm()
   â”‚         â””â”€ HTTP é”™è¯¯ â†’ Err(LlmError) â†’ å‘ä¸Šä¼ æ’­
   â”‚
   â””â”€ submit_question()
        â””â”€ è¿”å›ç ä¸æ˜¯ 200 â†’ return Ok(ProcessResult::Skipped)

ä¸Šæ¸¸ (processing.rs) å¤„ç†:
   match flow.run() {
       Ok(Success) => stats.processed += 1,
       Ok(Skipped) => stats.skipped += 1,
       Err(e) => {
           log_error(e);
           stats.skipped += 1;
       }
   }
```

---

## å…­ã€å¹¶å‘æ¨¡å‹

```
App::run()
   â”‚
   â”‚ Vec<QuestionPage> (20 ä¸ªè¯•å·)
   â”‚
   â”œâ”€ Batch 1 (è¯•å· 1-5)
   â”‚    â”‚
   â”‚    â”œâ”€ tokio::spawn(process_paper(è¯•å·1)) â”€â”€â”
   â”‚    â”œâ”€ tokio::spawn(process_paper(è¯•å·2)) â”€â”€â”¤
   â”‚    â”œâ”€ tokio::spawn(process_paper(è¯•å·3)) â”€â”€â”¼â”€ Semaphore (é™åˆ¶å¹¶å‘ = 5)
   â”‚    â”œâ”€ tokio::spawn(process_paper(è¯•å·4)) â”€â”€â”¤
   â”‚    â””â”€ tokio::spawn(process_paper(è¯•å·5)) â”€â”€â”˜
   â”‚         â”‚
   â”‚         â””â”€ ç­‰å¾…æ‰€æœ‰å®Œæˆ
   â”‚
   â”œâ”€ Batch 2 (è¯•å· 6-10)
   â”‚    â””â”€ ... (åŒä¸Š)
   â”‚
   â””â”€ ...

æ¯ä¸ª process_paper() å†…éƒ¨:
   for question in paper.stemlist {
       // ä¸²è¡Œå¤„ç†æ¯é“é¢˜
       flow.run(page, question, ctx).await
   }

æ³¨æ„ï¼š
- è¯•å·ä¹‹é—´ï¼šå¹¶å‘ï¼ˆtokio::spawnï¼‰
- é¢˜ç›®ä¹‹é—´ï¼šä¸²è¡Œï¼ˆå…±äº«åŒä¸€ä¸ª pageï¼‰
```

---

## ä¸ƒã€æ—¥å¿—æµå‘

```
æ¯é“é¢˜ç›®å¤„ç†:
   â”‚
   â”œâ”€ [è¯•å· 1] å¤„ç†ç¬¬ 1/10 é“é¢˜ç›®
   â”œâ”€ [è¯•å· 1] é¢˜å¹²: 1+1=?
   â”œâ”€ [è¯•å· 1] ğŸ” æ­£åœ¨é¢˜åº“ä¸­æœç´¢...
   â”œâ”€ [è¯•å· 1] âœ“ æœç´¢å®Œæˆï¼Œæ‰¾åˆ° 5 ä¸ªç›¸ä¼¼é¢˜ç›®
   â”œâ”€ [è¯•å· 1] âœ“ é€‰æ‹©äº†ç¬¬ 1 ä¸ªç»“æœ (ç›¸ä¼¼åº¦: 0.95)
   â”œâ”€ [è¯•å· 1] ğŸ“¤ æ­£åœ¨æäº¤é¢˜ç›®åˆ°é¢˜åº“...
   â””â”€ [è¯•å· 1] âœ“ é¢˜ç›®æäº¤æˆåŠŸ

è¯•å·å®Œæˆ:
   â”‚
   â”œâ”€ [è¯•å· 1] é¢˜ç›®ç»Ÿè®¡: æˆåŠŸ 8, è·³è¿‡ 2, æ€»è®¡ 10
   â””â”€ [è¯•å· 1] âœ… è¯•å·å¤„ç†å®Œæˆ

æ‰¹æ¬¡å®Œæˆ:
   â”‚
   â””â”€ âœ“ ç¬¬ 1 æ‰¹å®Œæˆ: æˆåŠŸ 5/5

å…¨éƒ¨å®Œæˆ:
   â”‚
   â”œâ”€ ğŸ“Š å…¨éƒ¨å¤„ç†å®Œæˆç»Ÿè®¡
   â”œâ”€ âœ… æˆåŠŸ: 18/20
   â””â”€ âŒ å¤±è´¥: 2
```

---

## å…«ã€å…³é”®æ•°æ®ç»“æ„çš„ç”Ÿå‘½å‘¨æœŸ

```
main() 
   â”‚
   â””â”€ config = Config::from_env()  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                     â”‚
        â””â”€ App::initialize(config)            â”‚
             â”‚                                â”‚
             â”œâ”€ browser, page = connect()     â”‚
             â”‚                                â”‚
             â””â”€ App { config, browser, page } â”‚
                  â”‚                           â”‚
                  â””â”€ App::run()               â”‚
                       â”‚                      â”‚
                       â”œâ”€ papers = load()     â”‚
                       â”‚                      â”‚
                       â””â”€ for batch in papers â”‚
                            â”‚                 â”‚
                            â””â”€ for paper      â”‚
                                 â”‚            â”‚
                                 â”œâ”€ flow = QuestionFlow::new(&config) â—„â”€â”˜
                                 â”‚     â”‚
                                 â”‚     â””â”€ æŒæœ‰ config çš„ clone
                                 â”‚
                                 â””â”€ for question
                                      â”‚
                                      â”œâ”€ ctx = QuestionCtx::new(...)
                                      â”‚     â””â”€ ä¸´æ—¶å¯¹è±¡ï¼ˆæ ˆä¸Šï¼‰
                                      â”‚
                                      â””â”€ flow.run(&page, &question, &ctx)
                                            â”‚
                                            â””â”€ æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯å¼•ç”¨ï¼ˆå€Ÿç”¨ï¼‰

ç”Ÿå‘½å‘¨æœŸæ€»ç»“:
- config: 'static (æ•´ä¸ªç¨‹åº)
- page: 'app (App ç”Ÿå‘½å‘¨æœŸ)
- flow: 'æ¯ä¸ª process_paper è°ƒç”¨
- ctx: 'æ¯é“é¢˜ç›®å¤„ç†
```

---

## ä¹ã€æœ€å°å·¥ä½œç¤ºä¾‹

```
1 ä¸ªè¯•å· â†’ 3 é“é¢˜ç›®

paper = QuestionPage {
  page_id: "123",
  stemlist: [
    Question { stem: "1+1=?", ... },
    Question { stem: "2+2=?", ... },
    Question { stem: "3+3=?", ... },
  ]
}

æ‰§è¡Œæµç¨‹:

App::run()
  â””â”€ process_paper(&page, paper, 1, &config)
       â”‚
       â”œâ”€ flow = QuestionFlow::new(&config)
       â”‚
       â”œâ”€ Question 1: "1+1=?"
       â”‚    â”‚
       â”‚    â”œâ”€ ctx = QuestionCtx { paper_id: "123", question_index: 1, ... }
       â”‚    â”œâ”€ flow.run(&page, &q1, &ctx)
       â”‚    â”‚    â””â”€ æœç´¢ â†’ åŒ¹é… â†’ æäº¤ â†’ Success
       â”‚    â””â”€ stats.processed += 1
       â”‚
       â”œâ”€ Question 2: "2+2=?"
       â”‚    â”‚
       â”‚    â”œâ”€ ctx = QuestionCtx { paper_id: "123", question_index: 2, ... }
       â”‚    â”œâ”€ flow.run(&page, &q2, &ctx)
       â”‚    â”‚    â””â”€ æœç´¢ â†’ ä¸ºç©º â†’ write_warn â†’ Skipped
       â”‚    â””â”€ stats.skipped += 1
       â”‚
       â””â”€ Question 3: "3+3=?"
            â”‚
            â”œâ”€ ctx = QuestionCtx { paper_id: "123", question_index: 3, ... }
            â”œâ”€ flow.run(&page, &q3, &ctx)
            â”‚    â””â”€ æœç´¢ â†’ åŒ¹é… â†’ æäº¤å¤±è´¥ â†’ Skipped
            â””â”€ stats.skipped += 1

æœ€ç»ˆ: processed = 1, skipped = 2, total = 3
```

---

## åã€æ•°æ®æµæ€»ç»“

| å±‚çº§ | è¾“å…¥ | è¾“å‡º | å‰¯ä½œç”¨ |
|------|------|------|--------|
| **App** | Config | ç»Ÿè®¡ä¿¡æ¯ | è¿æ¥æµè§ˆå™¨ã€æ—¥å¿— |
| **process_paper** | Page, Paper, Config | bool | æ¸…ç†æ–‡ä»¶ |
| **QuestionFlow** | Page, Question, Ctx | ProcessResult | å†™ warn.txt |
| **SearchService** | Page, stem, code | Vec<Result> | HTTP è¯·æ±‚ |
| **MatchingService** | results, stem, imgs | index | HTTP è¯·æ±‚ |
| **Page (eval)** | js_code | JSON | æµè§ˆå™¨æ‰§è¡Œ |

**æ•°æ®åªå‘ä¸‹æµåŠ¨ï¼Œç»“æœå‘ä¸Šè¿”å›ï¼Œå‰¯ä½œç”¨æ˜ç¡®æ ‡æ³¨ã€‚**
